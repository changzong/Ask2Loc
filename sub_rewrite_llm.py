import transformers
from transformers import TextGenerationPipeline
import torch
import os
import pdb

class SubRewrite(object):
    def __init__(self, lang='en'):
        if lang == 'en':
            self.model_name = 'llama-3.1-8b-instruct'
            self.prompt = '''Please refer to the complete subtitles from a video below, and rewrite the current subtitle, which is  to briefly describe what is happening now in the video. Please output the description directly without any context information. \n\nComplete Subtitles: <all_subtitles> \n\nCurrent Subtitle: <subtitle> \n\nYour Description: '''
        elif lang == 'zh':
            self.model_name = 'llama3-8b-chinese-chat'
            self.prompt = '''请参考以下视频完整字幕，对以下当前字幕进行重写，简要描述当前正在发生什么。请直接输出描述文本。\n\n视频完整字幕：<all_subtitles> \n\n当前字幕：<subtitle> \n\n描述文本：'''
        self.model_path = '../../models/' + self.model_name
        self.messages = [
            {"role": "user", "content": self.prompt},
        ]
        self.pipeline = transformers.pipeline(
            "text-generation", 
            model=self.model_path, 
            model_kwargs={"torch_dtype": torch.bfloat16}, 
            device="cuda:0"
        )

    def llama_generate(self):
        terminators = [
            self.pipeline.tokenizer.eos_token_id,
            self.pipeline.tokenizer.convert_tokens_to_ids("<|eot_id|>")
        ]
        outputs = self.pipeline(
            self.messages,
            eos_token_id=terminators,
            do_sample=True,
            temperature=0.6,
            top_p=0.9,
            pad_token_id = self.pipeline.tokenizer.eos_token_id,
            max_new_tokens=1024,
            continue_final_message=False,
        )
        generated_text = outputs[0]["generated_text"][-1]
        return generated_text
    
    def generate(self):
        if 'llama' in self.model_name or 'Llama' in self.model_name:
            return self.llama_generate()
        else:
            raise Exception("Unsupported LLM.")


if __name__ == '__main__':
    llm = SubRewrite()
    message = '''Please refer to the complete subtitles from a video below, and rewrite the current subtitle, which is  to briefly describe what is happening now in the video. Please output the description directly without any context information. \n\nComplete Subtitles: <all_subtitles> \n\nCurrent Subtitle: <subtitle> \n\nYour Description: '''
    all_subtitles = '''In this video, I'm going to\nshow you how to get rid of calf muscle pain for good. Stay\ntuned. Hey, everyone. Dr. Rowe coming\nto you from SpineCare in Saint Joseph, Michigan. In this\nvideo, we're going to deal with tight, achy, dull, painful\ncalves and I'm going to break it down into a very easy\nthree-part guide. In the first part, we're going to focus on a\nwonderful self-massage technique. It might end up\nbecoming your new favorite therapy. In the second part,\nwe're going to get everything loosened up and moving with\ngreat stretching exercises for the calves and the third part,\nwe're going to focus on strengthening those calves with\nvery easy to do exercises that may help lead to less instances of\ncalf pain in the future. All these exercises can be done at\nhome, don't require any special equipment and may give quick\nrelief, even in as little as thirty seconds. So, let's get\nstarted and get rid of that calf pain right now. In the\nfirst part, let's try to focus on getting instant pain relief\ninto our calf muscles with what is called Gua Sha or muscle\nscraping. It's a wonderful technique at getting rid of\nmuscle tightness, muscle spasms, cramps, trigger points,\nyou name it very easily and very effectively. We need two\nthings. The first being a large metal spoon. I like one with a\nlittle bit more thickness. You'll get better results. The\nnext is a form of lubrication. You can use any massage lotions\nor massage creams. You can even use pain relief creams such as\nBiofreeze or Icy Hot. Just coat pretty much from the knee all\nthe way down to the ankle, front, and back and when it\ncomes to lubrication, a little bit more is always better. So,\nafter we've done that, what I'm going to do is take my spoon.\nIt doesn't really matter what part of the spoon you take. I\nfind that using the handle is a little bit easier but you can\nuse the rounded portion here. Actually, experiment with it.\nTake what is most effective but what I'm going to do is start\nat the bottom of the leg, right at the ankle and when you do\nthis, make sure to only go over soft tissue. Muscle that you\ncan grab onto, skin, stay off any bony spots like this\nbecause that can cause irritation and we definitely\ndon't want that. So, I'm going to take my spoon and I'm going to\nuse the handle right here and put it in about a thirty-degree\nangle and I'm going to press into the point there's enough\npressure that once I start to scrape upwards like this, it\nwill feel like a nice self massage. We don't want this to\ncause discomfort. So, if it does back off a little bit,\nonly go to your comfort level but just work your way up. When\nyou do this, you want to go bottom to the top. And you want\nto do about five to ten slow repetitions in each spot and\nthen once you're done with that, just switch over to a\ndifferent spot and repeat. You want to go front to back and\npretty much just target those spots. When you do this all you\nmight find that one certain spot just feels very gritty,\nalmost like sandpaper. That's a spot of adhesion and you want\nto make note of that. That's usually a spot that's causing\ntightness and possibly pain and you want to break that up. When\nyou do this also, you might notice that pockets of redness\nform on the top of the skin. That is completely normal.\nThat's blood flow coming into the area which is good. It's\nimproving circulation and bringing in blood to hopefully\npromote healing but once you're done with that, really try to\nfocus on the front here on the shin. Shin pain is very common\nso really attack that but work your way up into the calf all\nthe way up to the knee front and back when you're done with\nthat you can definitely use different parts of the spoon,\nyou know dig in there and experiment with it. You can also\nattack it at different angles so instead of going up with it\ngo at 45° forward and then go 45° backwards, take whatever you\nfeel is working the best and any spots that feel like\nthey're, you know, locked up, tight throw more repetitions in\nthere to break up that muscle tightness that spasm whatever\nyou might have. Once we're done with that, let's throw some\nmotion into that calf muscle to challenge it to open up new\nspots that might be causing pain or discomfort. So, what\nI like to do is press from my heel into the floor and then,\nI'm going to just take my toes upwards towards the ceiling.\nWhat this will do is activate that calf muscle. So, again,\nstart to go over that and you may find that new spots of\ntightness have formed or new spots of pain can be\ntargeted. So, really dig in there and try to loosen that up\nI also like to do a little bit more ankle motion so what I'm\ngoing to do is turn my ankle inward repeat that and then\nonce I'm done with that I'm going to turn my ankle outwards\nand then repeat that also because this just activates\nthat calf muscle just a little bit differently but go through\nall of those motions go through all of the areas target spots\nof adhesion or any spots that you feel are tight and achy, try\nto loosen that up and I hope that that gives you a lot of\nquick calf pain relief. In the second part led focus on\ngetting rid of calf muscle pain with some wonderful stretching\nexercises let's just get everything loosened up this\nfirst exercise is called a calf rock back, it's very easy to do.\nWe're going to start off on all fours on the floor just like\nthis from there what I'm going to do is go into kind of like a\npush up position I'm going to put my feet out like this my\nweight is going to be placed on my toes whatever side that\nwe're focusing on let's say that I have a little bit more\noff to my right I'm going to lift my left leg up, keep my right\nleg straight, and then just place my foot over the calf\nmuscle on the right side just like this. What I want to do\nfrom there is a rocking motion. So, I'm going to rock forward\nthat is with my whole body is one complete movement rocking\nforward by driving through my toes. When you do this, you're\ngoing to feel the muscles into that calf really start to fire.\nReally focus on that as much as you can. You want to feel it\ninto the calves but hold this position for about three to\nfive seconds. From there, you're going to try to then\ntake the heel towards the floor. Press with your hands\nright here too to lower your heel down even further and it\nis a deep stretch into that calf muscle. Again, hold three\nto 5 seconds, only to your comfort level. From there, just\ndo this for about fifteen complete repetitions. With each\nrepetition, always challenge yourself to go forward and then\nbackwards even more. It'll help engage those muscles even more\nto hopefully give you more pain relief and when you're done on\none side, always switch to the other to keep them both in\nbalance. So, here is a great calf stretching exercise that\nyou can pretty much do anywhere even at work. You just need to\ngo next to a door or a wall. I recommend doing it next to a\ndoor because you'll see why here in just a minute. What I'm\ngoing to do is start off in a scissored stance like this.\nWhatever side that we're focusing on. In this case, I'm\nhaving right calf pain. I want to place that one forward and\nthen I'm going to put my toes on the door and then lower my\nheel down into the floor for stable anchor point when you do\nthis too you also want to bring the toes back towards you or\nraise them up on the door as much as possible. Build an\ninitial stretch into that calf muscle. You want an initial\nstretch to begin with. You'll get better results with this.\nYou can then take a hand whatever side you want. Grab on\nto the doorknob if you need to for extra stability but what I\nwant to do is keep this knee straight, the side that we're\nfocusing on. The other one can go bent. I'm gonna use this\nback leg right here to push forward with my body weight.\nSo, I'm kinda lifting off like this and pressing my body\ntowards that door of the wall. The more that you do this, go\nforward, the more intense the stretch is going to be felt\ninto the calves. Only go to your comfort level. Hold this\ncomfortably for twenty seconds. From there, relax, take a\nbreather, and then repeat this up to five times. With each\nrepetition, try to drive your body weight forward even more.\nBecause it will only help stretch those calves out and\nhopefully lead to more pain and tightness relief. If you want\nto take this one to the next level, what you can do is\nstretch into it but then pull forward even more with the\ndoorknob. So, I'm using my hand right here at the doorknob to\npull myself forward even more and this can become extremely\nintense of a stretch. So, again, only to your comfort\nlevel. If you want to take this one even to the next level,\nmove over to the door frame right here. Open the door, grab\nof that door frame and pull yourself forward even more but\nagain, only to your comfort level. Go through those, take\nwhat is most effective and remember, always switch to the\nother side to keep them both in balance. So, without a doubt,\nif we want to get rid of calf pain for good, we have to\nstrengthen all of those muscles to hopefully future proof them\nfrom pain and tightness. This one is best done next to a\nstaircase but you can also use something like a yoga block and\nI will get grief for this but you can use a stack of hard\ncover books or just a block of wood. I call this the calf\nsmashing circuit and if your calf had a butt, this would\nkick it. So, I'm going to step up onto that stair or that yoga\nblock to the point where my heels are going to be off, my\ntoes are going to be on. If you are in a staircase, just take\nyour hands, grab off to the side right here on those walls\nfor support. If you are doing it next to a wall, just grab\nonto it like this. What I'm gonna do first is a simple calf\nraise. That is just lid up with my feet trying to take my heels\nup towards the ceiling. Try to focus on feeling and activating\nthose calf muscles through all of these exercises. You should\nreally feel it into the calves. So, what you want to do is go\nto a comfortable point of activation of those muscles.\nHold this for five seconds. From there, come back down,\nrelax, take a breather, and then repeat this up to ten\ntimes. With each repetition, really focus on driving up even\nmore to challenge yourself to help strengthen those muscles.\nFrom the we want to do the opposite. So, let's go all the\nway up and then do a heel drop. That is just slowly coming down\nto the point where my heels are going down towards the floor.\nDo let them touch the floor though. Just let them hover.\nThis should take you about 5 seconds from going to the top\nall the way down to the bottom and really fight gravity and\nyour body weight. What you want to do for this one is ten\ncomplete repetitions. If this becomes too easy, what you can\ndo from there is just take one leg off and then repeat those\nexercises. It'll become more challenging because you have\nmore body weight to deal with. Once you're done with that,\nwhat we want is to focus on more dynamic movements.\nChallenge those muscles through different motions. What I'm\ngoing to do is what is called an eccentric calf raise. So,\nI'm going to tilt my body just a little bit towards one\ndirection. In this case, my right, and then I'm going to\nrepeat that calf raise. When you do this, you'll notice that\nthe muscles get hit just a little bit differently. And you\nwant to repeat this one again for five second holds for ten\nrepetitions. From there, go all the way towards the left and\nrepeat. Experiment with different angles. If one feels\nvery weak, like, let's say when I go to my right, it just feels\nvery weak compared to the left. I make note of that and I throw\nmore repetitions in to help strengthen those muscles to\nhopefully again future proof them from pain and tightness.\nYou can also do circular motions like this but you just\nwanna do that and then from there, switch to doing the heel\ndrops and do that same motion all the way towards the left,\ngo down a little bit, and then go all the way towards the\nright and focus on any motions with that heel drop that feel a\nlittle bit more weak and if it does feel like it's too easy,\njust take one leg off and repeat this. But whatever you\ndo on one side, always switch to the other to keep them both\nin balance. So, if you stuck around to the end of the video,\nyou're going to be rewarded with a great exercise that's\nnot only going to target the calves but pretty much the\nwhole legs, glutes, buttocks, core muscles, and lower back.\nThis one is known as the calf bridge. It's best done on the\nfloor. Let's lay it flat on our back. Put our head down like\nthis. What I'm going to do from here is raise my heels up\ntowards the ceiling as much as I can and drive my leg weight\ninto my toes into the floor for a stable anchor point. From\nthere, hands go on the hip and I'm going to lift my butt up\ntowards the ceiling as much as I can. You want to pretty much\nhave your knees to the hips to the shoulders in a nice\nstraight line. Really focus on feeling into the calf muscles.\nIf it doesn't feel like it's really activating them, what\nyou need to do is lift the heels up even more until you\nfeel it. Once we hit that very comfortable activation of the\nmuscles and I'm telling you what, it activates a lot of\nmuscles in this exercise. Let's hold this for five seconds.\nFrom there, relax, take a breather, and then repeat this\none up to ten times with each repetition. Drive the heels up\ntowards the ceiling, lift the butt up even more to challenge\nthose muscles to hopefully strengthen everything. Again\nfuture proof things from pain and tightness if this becomes\ntoo easy you can take one leg off like this and repeat and it\nbecomes extremely challenging so try that one and remember\nwhatever you do on one side always switch to the other to\nkeep them both in balance. If the video helped, please support\nthe channel by giving this video a like and also maybe\nsubscribing to our channel too. If you have any comments or\nquestions, please leave them below I'll get back to you as\nsoon as I can. Thank you for watching!'''
    subtitle = "really activating them, what you need to do is lift the heels up even more until you feel it. Once we hit that very comfortable activation of the muscles and I'm telling you"
    llm.messages[0]['content'] = message.replace('<all_subtitles>', all_subtitles).replace('<subtitle>', subtitle)

    pdb.set_trace()
    desc = llm.generate()
    print(desc)
    subtitle = "core muscles, and lower back. This one is known as the calf bridge. It's best done on the floor. Let's lay it flat on our back. Put our head down like this. What I'm going to do from"
    
    llm.messages[0]['content'] = message.replace('<all_subtitles>', all_subtitles).replace('<subtitle>', subtitle)
    pdb.set_trace()
    desc = llm.generate()
    print(desc)
